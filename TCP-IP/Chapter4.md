## Chapter4 IPプロトコル

### IPはインターネット層のプロトコル

- TCP/IPのインターネット層は主にIP(Internet Protocol)とICMP(Internet Control Message Protocol)の２つのプロトコルから構成されている。またIPの新しいバージョンとしてIPv6(IP version 6)がある

#### IPはOSI参照モデルの第３層に相当

- ネットワーク層の役割は「終点ノード間の通信を実現する（エンドツーエンド）」である
- データリンク層では、同じ種類のデータリンクだけで接続されているノード間のパケット転送を行うが、ネットワーク層では異なる種類のデータリンクであっても連携をとりながらパケットを配送することができる

**ホストとノード**

- インターネットの世界では、IPアドレスがつけられた機器を「ホスト」という。
- 「ホスト」はIPアドレスはつけられているが、経路制御を行わない機器という意味でもある。経路制御を行う場合「ルーター」と呼び、その２つを合わせると「ノード」となる

#### ネットワーク層とデータリンク層の関係

- 旅行する場合を例とすると、飛行機や電車、バスなどを乗り継いで行く時、その区間をデータリンク、その切符や航空券がプロトコル、旅行の工程表がネットワーク層に当たる
- 工程表だけでは乗り物に乗れず、目的地には行けない。逆に、切符だけでは目的地がわからないので行けない、ということである

![IPの役割とデータリンクの役割](https://raw.githubusercontent.com/shinzanmono/Markdown/07e943317bc5ae719ef7a82c7d9d061bdc6a1782/images/datalink-and-ip.drawio.svg)

### IPの基礎知識

- IPには大きく３つの役割がある。IPアドレス、終点ホストまでのパケット配送（ルーティング）、IPパケットの分割処理と再構築処理

#### IPアドレスはネットワーク層のアドレス

- IPアドレスは「ネットワークに接続されているすべてのホストの中から、通信を行う宛先を識別する」時に使用される。
- 形式は、データリンクに左右されず、全く同じものが使われる。
- ブリッジやスイッチングハブなど、物理層やデータリンク層でパケットを中継する機器には、IPアドレスは不要

#### 経路制御（ルーティング）

- ルーティングは「宛先IPアドレスのホストまでパケットを届けるための機能」である

**最終的な宛先ホストまでのパケット配送**

- TCP/IPではホップ(hop)という単位があり、ネットワークの1区間のことをいう。IPの経路制御はホップバイホップルーティングという方式で行われる
- ホップバイルーティングでのルーターやホストは、IPパケットの転送先となるルーターやホストを支持するだけで、最終目的地までの経路を指示するわけではない
- まず1区間までの場所まで移動し、そこで目的地までの道を聞く。これを繰り返して目的地まで向かう。
- この時の目的地まで向かう人がIPパケット、区間での道を教える人がルーター、移動手段がデータリンクとなる

**１ホップの範囲**

- １ホップはデータリンク層以下の機能だけを使ってフレームが伝送される1区間を意味する

**経路制御表（ルーティングテーブル）**

- 宛先のホストまでパケットを送るため、すべてのホストやルーターは経路制御表と呼ばれる情報を持っている。この表にはIPパケットを次にどのルーターへ送ればよいかが記されている

#### データリンクの抽象化

- IPは複数のデータリンク間の通信を実現するプロトコル。また様々なデータリンク固有の特徴を抽象化するのもIPの重要な役割
- IPの上位層からは実際の通信が、イーサネット、無線LAN、PPPなどで行われようと、全く同じように見えなければいけない
- MTUを超えるパケットを要求する場合、IPでは分割処理（フラグメンテーション）を行い、大きなIPパケットを複数の小さいIPパケットに分割する。

![データリンクによってMTU(Maximum Transmission Unit)が異なる](https://raw.githubusercontent.com/shinzanmono/Markdown/e7d21c15291c7995509d8037f51cad128ddd7191/images/datalink-MTU.drawio.svg)

#### IPはコネクションレス型

- コネクションレス型は機能の簡略化と高速化が売り。コネクション型のサービスが必要な場合は、上位層が提供する
- IPは最善努力型（Best Effort）のサービスと呼ばれている。「パケットを宛先まで送り届けようと最大限の努力」をするから
- 信頼性を高めるのはTCP/IPの役割。なぜIPに信頼性を持たせないで、２つのプロトコルに分けるのか。その理由は、1つのプロトコルで何もかもやろうとすると、そのようなプロトコルを定義したり実装（プログラミング）したりするのは難しいから
- また２つに分けることで、プロトコルの定義や役割、目標が明確になり、昨日の拡張や性能の向上が容易になる。

### IPアドレスの基礎知識

- TCP/IPで通信する時には、IPアドレスを使ってホストやルーターが識別される。
- インターネットで通信をするためには、世界全体で正しくIPアドレスを割り当て、設定、管理、運用をしなければいけない

#### IPアドレスとは

- IPアドレス（IPv4アドレス）は32ビットの正整数値で表される。TCP/IPで通信する場合は、このIPアドレスを個々のホストに割り当てなければいけない
- IPアドレスはコンピュータ内部では2進数で処理される。が人間にとって2進数は非常にわかりにくいため、32ビットのIPアドレスを8ビットずつの4つの組に分け、境目にピリオドを挿入し10進数で表現する方法が用いられている（ドット・デシマル・ノーテーション）

```text
10101100    00010100    0000001    0000001 (2進数)
10101100.   00010100.   0000001.   0000001 (2進数)
172.        20.          1.        1       (10進数)

IPアドレスで表すことのできる数は
2の32乗で4,294,967,296となる
```

#### IPアドレスはネットワーク部とホスト部から構成される

- ネットワーク部（ネットワークアドレス部）は、データリンクのセグメントごとに値が割り当てられる。接続されているセグメントのアドレスと重ならないように設定される。ホスト部も、同一セグメント内で重ならない値を割り当てられる
- 初期のIPでは、ネットワーク部とホスト部はクラスによって分けられていたが、現在はサブネットマスク（ネットワークプレフィクス）によって分けられる

![IPアドレスのホスト部とネットワーク部](https://raw.githubusercontent.com/shinzanmono/Markdown/42cbdb64898c1239a9796a5c34d782babdbb517a/images/ipaddress-network-host.drawio.svg)

#### IPアドレスのクラス

| クラス  | ネットワーク部                                               | ホスト部                               |
| ------- | ------------------------------------------------------------ | -------------------------------------- |
| クラスA | 先頭ビットが0から始まる<br />8ビットまでがネットワーク部（0.0.0.0~127.0.0.0） | 167,777,214(256**3-2)通りある          |
| クラスB | 先頭ビット10で始まる<br />16ビットまでがネットワーク部（128.0.0.0~191.0.0.0） | 65534(256**2-1)通りある                |
| クラスC | 先頭ビット110から始まる<br />24ビットまでがネットワーク部（192.0.0.0~223.0.0.0） | 254(256-2)通りある                     |
| クラスD | 先頭ビット1110から始まる<br />32ビットまでがネットワーク部（224.0.0.0~239.255.255.0） | なし。<br />IPマルチキャストに使われる |

#### ブロードキャストアドレス

- 同一リンクに接続されたすべてのホストにパケットを送信するためのアドレス。ホスト部のビットを全て１にするとブロードキャストアドレスとなる（イーサネットではMACアドレスをFF:FF:FF:FF:FF:FFがブロードキャストアドレスとなる）
- 例えば`127.20.0.0/16`を二進数で`10101100.00010100.00000000.00000000`になり、ブロードキャストアドレスは`10101100.00010100.11111111.11111111`になり、`127.20.255.255`となる

**二つのブロードキャスト**

- ブロードキャストにはローカルブロードキャストと、ダイレクトブロードキャストの2つがある
- ローカルブロードキャストは自分が属しているリンク内のブロードキャスト。`192.168.0.0/24`の場合、ブロードキャストアドレスは`192.168.0.255`となる。このIPブロードキャストが設定されたIPパケットは、ルーターで遮断され`192.168.0.0/24`以外の異なるリンクには到達しない
- ダイレクトブーロードキャストは異なるIPネットワークをブロードキャストする。`192.168.0.0/24`内のホストが宛先IPアドレスを`192.168.1.255`にしてIPパケットを送信したとして、受信したルーターは、パケットを目的のネットワーク`192.168.1.0/24`に転送する。これにより`192.168.1.1`~`192.168.1.254`までのすべてのホストにパケットを送ることができる
