## Chapter4 IPプロトコル

### IPはインターネット層のプロトコル

- TCP/IPのインターネット層は主にIP(Internet Protocol)とICMP(Internet Control Message Protocol)の２つのプロトコルから構成されている。またIPの新しいバージョンとしてIPv6(IP version 6)がある

#### IPはOSI参照モデルの第３層に相当

- ネットワーク層の役割は「終点ノード間の通信を実現する（エンドツーエンド）」である
- データリンク層では、同じ種類のデータリンクだけで接続されているノード間のパケット転送を行うが、ネットワーク層では異なる種類のデータリンクであっても連携をとりながらパケットを配送することができる

**ホストとノード**

- インターネットの世界では、IPアドレスがつけられた機器を「ホスト」という。
- 「ホスト」はIPアドレスはつけられているが、経路制御を行わない機器という意味でもある。経路制御を行う場合「ルーター」と呼び、その２つを合わせると「ノード」となる

#### ネットワーク層とデータリンク層の関係

- 旅行する場合を例とすると、飛行機や電車、バスなどを乗り継いで行く時、その区間をデータリンク、その切符や航空券がプロトコル、旅行の工程表がネットワーク層に当たる
- 工程表だけでは乗り物に乗れず、目的地には行けない。逆に、切符だけでは目的地がわからないので行けない、ということである

![IPの役割とデータリンクの役割](https://raw.githubusercontent.com/shinzanmono/Markdown/07e943317bc5ae719ef7a82c7d9d061bdc6a1782/images/datalink-and-ip.drawio.svg)

### IPの基礎知識

- IPには大きく３つの役割がある。IPアドレス、終点ホストまでのパケット配送（ルーティング）、IPパケットの分割処理と再構築処理

#### IPアドレスはネットワーク層のアドレス

- IPアドレスは「ネットワークに接続されているすべてのホストの中から、通信を行う宛先を識別する」時に使用される。
- 形式は、データリンクに左右されず、全く同じものが使われる。
- ブリッジやスイッチングハブなど、物理層やデータリンク層でパケットを中継する機器には、IPアドレスは不要

#### 経路制御（ルーティング）

- ルーティングは「宛先IPアドレスのホストまでパケットを届けるための機能」である

**最終的な宛先ホストまでのパケット配送**

- TCP/IPではホップ(hop)という単位があり、ネットワークの1区間のことをいう。IPの経路制御はホップバイホップルーティングという方式で行われる
- ホップバイルーティングでのルーターやホストは、IPパケットの転送先となるルーターやホストを支持するだけで、最終目的地までの経路を指示するわけではない
- まず1区間までの場所まで移動し、そこで目的地までの道を聞く。これを繰り返して目的地まで向かう。
- この時の目的地まで向かう人がIPパケット、区間での道を教える人がルーター、移動手段がデータリンクとなる

**１ホップの範囲**

- １ホップはデータリンク層以下の機能だけを使ってフレームが伝送される1区間を意味する

**経路制御表（ルーティングテーブル）**

- 宛先のホストまでパケットを送るため、すべてのホストやルーターは経路制御表と呼ばれる情報を持っている。この表にはIPパケットを次にどのルーターへ送ればよいかが記されている

#### データリンクの抽象化

- IPは複数のデータリンク間の通信を実現するプロトコル。また様々なデータリンク固有の特徴を抽象化するのもIPの重要な役割
- IPの上位層からは実際の通信が、イーサネット、無線LAN、PPPなどで行われようと、全く同じように見えなければいけない
- MTUを超えるパケットを要求する場合、IPでは分割処理（フラグメンテーション）を行い、大きなIPパケットを複数の小さいIPパケットに分割する。

![データリンクによってMTU(Maximum Transmission Unit)が異なる](https://raw.githubusercontent.com/shinzanmono/Markdown/e7d21c15291c7995509d8037f51cad128ddd7191/images/datalink-MTU.drawio.svg)

#### IPはコネクションレス型

- コネクションレス型は機能の簡略化と高速化が売り。コネクション型のサービスが必要な場合は、上位層が提供する
- IPは最善努力型（Best Effort）のサービスと呼ばれている。「パケットを宛先まで送り届けようと最大限の努力」をするから
- 信頼性を高めるのはTCP/IPの役割。なぜIPに信頼性を持たせないで、２つのプロトコルに分けるのか。その理由は、1つのプロトコルで何もかもやろうとすると、そのようなプロトコルを定義したり実装（プログラミング）したりするのは難しいから
- また２つに分けることで、プロトコルの定義や役割、目標が明確になり、昨日の拡張や性能の向上が容易になる。

### IPアドレスの基礎知識

- TCP/IPで通信する時には、IPアドレスを使ってホストやルーターが識別される。
- インターネットで通信をするためには、世界全体で正しくIPアドレスを割り当て、設定、管理、運用をしなければいけない

#### IPアドレスとは

- IPアドレス（IPv4アドレス）は32ビットの正整数値で表される。TCP/IPで通信する場合は、このIPアドレスを個々のホストに割り当てなければいけない
- IPアドレスはコンピュータ内部では2進数で処理される。が人間にとって2進数は非常にわかりにくいため、32ビットのIPアドレスを8ビットずつの4つの組に分け、境目にピリオドを挿入し10進数で表現する方法が用いられている（ドット・デシマル・ノーテーション）

```text
10101100    00010100    0000001    0000001 (2進数)
10101100.   00010100.   0000001.   0000001 (2進数)
172.        20.          1.        1       (10進数)

IPアドレスで表すことのできる数は
2の32乗で4,294,967,296となる
```

#### IPアドレスはネットワーク部とホスト部から構成される

- ネットワーク部（ネットワークアドレス部）は、データリンクのセグメントごとに値が割り当てられる。接続されているセグメントのアドレスと重ならないように設定される。ホスト部も、同一セグメント内で重ならない値を割り当てられる
- 初期のIPでは、ネットワーク部とホスト部はクラスによって分けられていたが、現在はサブネットマスク（ネットワークプレフィクス）によって分けられる

![IPアドレスのホスト部とネットワーク部](https://raw.githubusercontent.com/shinzanmono/Markdown/42cbdb64898c1239a9796a5c34d782babdbb517a/images/ipaddress-network-host.drawio.svg)

#### IPアドレスのクラス

| クラス  | ネットワーク部                                               | ホスト部                               |
| ------- | ------------------------------------------------------------ | -------------------------------------- |
| クラスA | 先頭ビットが0から始まる<br />8ビットまでがネットワーク部（0.0.0.0~127.0.0.0） | 167,777,214(256**3-2)通りある          |
| クラスB | 先頭ビット10で始まる<br />16ビットまでがネットワーク部（128.0.0.0~191.0.0.0） | 65534(256**2-1)通りある                |
| クラスC | 先頭ビット110から始まる<br />24ビットまでがネットワーク部（192.0.0.0~223.0.0.0） | 254(256-2)通りある                     |
| クラスD | 先頭ビット1110から始まる<br />32ビットまでがネットワーク部（224.0.0.0~239.255.255.0） | なし。<br />IPマルチキャストに使われる |

#### ブロードキャストアドレス

- 同一リンクに接続されたすべてのホストにパケットを送信するためのアドレス。ホスト部のビットを全て１にするとブロードキャストアドレスとなる（イーサネットではMACアドレスFF:FF:FF:FF:FF:FFがブロードキャストアドレスとなる）
- 例えば`127.20.0.0/16`を二進数で`10101100.00010100.00000000.00000000`になり、ブロードキャストアドレスは`10101100.00010100.11111111.11111111`になり、`127.20.255.255`となる

**二つのブロードキャスト**

- ブロードキャストにはローカルブロードキャストと、ダイレクトブロードキャストの2つがある
- ローカルブロードキャストは自分が属しているリンク内のブロードキャスト。`192.168.0.0/24`の場合、ブロードキャストアドレスは`192.168.0.255`となる。このIPブロードキャストが設定されたIPパケットは、ルーターで遮断され`192.168.0.0/24`以外の異なるリンクには到達しない
- ダイレクトブーロードキャストは異なるIPネットワークをブロードキャストする。`192.168.0.0/24`内のホストが宛先IPアドレスを`192.168.1.255`にしてIPパケットを送信したとして、受信したルーターは、パケットを目的のネットワーク`192.168.1.0/24`に転送する。これにより`192.168.1.1`~`192.168.1.254`までのすべてのホストにパケットを送ることができる

#### IPマルチキャスト

![ユニキャスト、ブロードキャスト、マルチキャストの通信](https://raw.githubusercontent.com/shinzanmono/Markdown/b2eb504c89c8a38daecd7c1982827127fb29a389/images/ip-malticast.drawio.svg)

**同時送信で効率アップ**

- マルチキャストは、特定のグループに所属するすべてのホストにパケットを送信する
- この機能が使われる前は、ブロードキャストで全端末にパケットを送信し、受信したホストのIPより上の層で必要なデータか否かをきめるほうほうだった。
- この方法では関係のないネットワークやホストまで巻き込み、ネットワーク全体のトラフィックも大きくなる。また異なるセグメントにパケットを送る場合、別の手段を用いないといけない

**IPマルチキャストとアドレス**

- IPマルチキャストでは、クラスDのIPアドレスを使用する。範囲は`224.0.0.0`から`239.255.255.255`までで、`224.0.0.0`から`224.0.0.255`までは経路制御されず、同一リンク内でもマルチキャストになり、それ以外のアドレスは全ネットワークのグループのメンバーに到達する。
- またすべてのホスト（ルーター以外のホスト、エンドホスト）は`224.0.0.1`、すべてのルーターは`224.0.0.2`のグループに属する必要がある。IPマルチキャストを使って実用的な通信をしようとすると、IGMP(Internet Group Management Protocol)などの仕組みが必要になる
- 用途が決められている代表的なマルチキャストアドレス：https://www.infraexpert.com/study/multicastz03.html

#### サブネットマスク

- IPアドレスのクラスには、無駄な部分が多い。例えばクラスBのIPネットワークを構築したとして、1つのリンク内で６万５千台のホストを接続することが可能だが、そんなにいらない
- 現在、IPアドレスを利用するときは、サブネットマスクと呼ばれる識別子が導入され、クラスA, B, Cのネットワークを小さく区切る左部ネットワークアドレス部として利用することで、複数の物理ネットワークに分割できるようにする仕組み

- サブネットの導入により、IPアドレスと、サブネットマスクの2つの識別子で表されるようになった。例えば、`172.20.100.52/26`だと`26`の部分が、IPアドレス32ビットの内、先頭26ビットから後ろがサブネットマスクということになる

#### CIDR(Classless InterDomain Routing)とVLSM(Valiable Length Subnet Mask)

- 1990年代半ばまでは、大規模なネットワーク構築にはクラスA、中規模はクラスB、小規模はクラスC、という感じだった。ただし、クラスBが人気で配布し尽くしてしまう可能性が出てきた
- そこで、クラス分けを廃止し、任意のビット長でIPアドレスを配布するようにした（CIDR）。CIDRを適用することによって、連続するクラスCアドレスを1つの大きなネットワークとして扱うことができるようになる。また、IPアドレス空間を有効活用できると同時に、経路情報を集約し圧縮することも可能になる
- 組織内の部署ごとにサブネットマスク長が変えられるようにする仕組みが、可変調サブネットマスクVLSMです。これは、ルーティングプロトコルをRIP2やOSPFに変更することで実現する。
- CIDRやVLSMの登場により、グローバルIPアドレスの絶対的な不足が一時的に解消されたが、IPアドレスの絶対数に限りがあることには変わりはない

#### グローバルアドレスとプライベートアドレス

- 元々インターネットでは、すべてのホストやルーターにユニークなIPアドレスを設定しなければいけなかった。IPアドレスの枯渇問題により、必要なところに必要な数だけユニークなIPアドレスを割り当てるようになった

- そこで、インターネットに接続していない私的なネットワークで利用できるプライベートIPアドレスが誕生する。

| Min         | Max             | Subnet       | Class   |
| ----------- | --------------- | ------------ | ------- |
| 10.0.0.0    | 10.255.255.255  | (10/8)       | クラスA |
| 172.16.0.0  | 172.31.255.255  | (172.16/12)  | クラスB |
| 192.168.0.0 | 192.168.255.255 | (192.168/16) | クラスC |

- 上記がプライベートIPアドレスの範囲で、範囲外がグローバルIPアドレス。また、プライベートIPアドレスとグローバルIPアドレスの間でアドレス変換をするNAT技術が誕生し、プライベートIPアドレスを割り当てたネットワーク上のホストから、グローバルアドレスを割り当てたインターネット上のホストと通信ができるようになる
- 現在では、インターネットに公開しているサーバーにだけグローバルIPアドレスを設定するのが一般的。つまりプライベートIPアドレスとNATを組み合わせた方法。
- しかし、この方法では様々な制限事項（例えば、アプリケーションヘッダやデータ部分でIPアドレスやポート番号を通知するようなアプリケーションはうまくいかないこと）がある。この解決にIPv6が作られたが、あまり普及が進んでおらず、従来の方法で間に合わせているのが現在のインターネット

#### グローバルIPアドレスは誰が決める

- グローバルIPアドレスはICANN(Internet Corporation for Assigned Names and Numbers)が一元管理されている。日本国内ではJPNIC(Japan Network Information Center)がグローバルIPアドレスの割り当て期間として活動している
- インターネットの商用化が進む以前は、ユーザーがJPNICから直接グローバルIPアドレスを取得していたが、現在はユーザーISPにインターネットの接続を依頼するときに、ISPが代わりにJPNICにアドレス割り当てを申請している。
- FTTHやADSLなどのインターネット接続サービスの場合、接続先のプロバイダのサーバーからIPアドレスが自動的に割り当てられ、接続し直すたびにIPアドレスが変化する場合がある

### 経路制御（ルーティング）

- パケットを配送するときに利用するのがIPアドレス。宛先にこのルーターやホストに送り出すといった情報が経路制御表（ルーティングテーブル）。また、通信するホストやルーターなどの機器は必ず経路制御表を持っている
- 経路制御表の作成は、管理者が事前に設定する方法と、ルーターが他のルーターと情報を交換して自動生成する方法がある。前者が静的経路制御、後者が動的経路制御という。
- 動的経路制御の場合には、ネットワークに接続されたルーター間で経路制御情報（ルーティングインフォメーション）のやり取りができるように、ルーティングプロトコルを設定しなければいけない
- IPは正しい経路制御表がある前提で動作する。しかし、IPでは経路制御表を作成するプロトコルを定義していない。つまり、IP自体には経路制御表を生成する機能はなく、ルーティングプロトコルがその役割を受け持つ

#### IPアドレスと経路制御（ルーティング）

![経路制御表とIPパケットの配送](https://raw.githubusercontent.com/shinzanmono/Markdown/f1f773a35d3a9dea5a25912dccffcf4509156e04/images/deliver-ippacket-routingtable.drawio.svg)

- 経路制御表には、ネットワークアドレスと、次に配送すべきルーターのアドレスが書かれている。IPパケットを送信するときは、宛先アドレスを調べて経路制御表から一致するネットワークアドレスを検索し、対応する次のルーターに配送する。ネットワークアドレスが複数ある場合は、一致するビット列の長いネットワークアドレスを選択する
- つまり、`172.20/16`と`172.20.100/24`だと後者を選択する。また、次に配送するルータのアドレスが記載されている場所にそのホストやルーター自身のネットワークインターフェースのIPアドレスが書かれている場合は、宛先のホストが同一データリンクに接続されているという意味

**デフォルトルート**

- すべてのネットワークやサブネットの情報を経路制御表に持たせると無駄が多くなるため、デフォルトルートが利用される。またデフォルトルートは`0.0.0.0/0`か`default`と記述される。

**ホストルート**

- IPアドレス/32はホストルートと呼ばれる。これはIPアドレスのすべてのビットを使って経路制御をするという意味。ホストルートを利用すると、ネットワーク部ではなく、ネットワークインターフェースにつけたIPアドレスに基づいて経路制御される。何らかの都合でネットワークアドレスによる経路制御を利用したくない場合に利用される

**ループバックアドレス**

- 同じコンピュータ内部のプログラム間で通信したい場合に利用される。ループバックアドレスには`127.0.0.1`か`localhost`が使われる。このアドレスを利用した場合、パケットはネットワークには流れない

#### 経路制御表の集約

- 内部で複数のサブネットワークから構成されていても、外部で代表する1つのネットワークアドレスで経路制御することができる。うまくネットワークを構築して経路制御情報を集約することで経路制御表を小さくすることができる。
- また、経路制御表を小さくすることで、経路制御表の管理に必要なメモリやCPU、検索にかかる負担や時間を軽減することができる。
