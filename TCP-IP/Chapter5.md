## Chapter5 IPに関連する技術

### IPだけでは通信できない

- この章ではIPを補助するDNS, ARP, ICMP, ICMPv6, DHCP, NATについて説明する。さらに、IPトンネリング、IPマルチキャスト、IPエニーキャスト、品質制御（QoS）、明示的なふくそう通知、Mobile IPについても説明する

- Webや電子メールを使うときは、IPアドレスではなく、Webサイトのアドレスや電子メールアドレスなど、アプリケーション層で決められているアドレスを使う。しかし実際に通信するにはIPアドレスが必要

### DNS(Domain Name System)

- DNSは、ローマ字とピリオドを使った名前からIPアドレスへと自動的に変換する。IPv4, IPv6で使われる

#### IPアドレスを覚えるのは大変

- ユーザーがアプリケーションを利用するときに通信相手をIPアドレスで直接指定するのはとても不便。また、数字の羅列（IPアドレス）よりも英文字列（DNS）の方が覚えやすい
- TCP/IPの世界では古くからホスト名と呼ばれるコンピュータに名前をつけてIPアドレスではなくホスト名で通信する方法が利用されていた。この機能を実現するために、ホスト名とIPアドレスの対応を定義するhostsと呼ばれるデータベースファイルが利用されていた
- ARPANETでは、hostsファイルをネットワークインフォメーションセンター（SRI-NIC）で一括管理されていた。ARPANETにコンピュータが接続されたり、IPアドレスが変更されたりしたときにはセンターのデータベースが更新され、他のコンピュータは定期的にセンターからデータベースをダウンロードしながら運用していた。
- これは、ネットワークの規模が大きくなり、接続するコンピュータが増えるとホスト名やIPアドレスの登録・変更処理を１ヶ所で管理するのは不可能になる

#### DNSの登場

- ホスト名とIPアドレスの対応関係を効率よく管理するためにDNSが考えられた。これは組織内でホスト名とIPアドレスの関係を表すデータベースを管理することができる方法。
- 現在ユーザーがWebブラウザなどのアプリケーションを利用するときにホスト名を入力するだけで通信できるのは、DNSのお陰

#### ドメイン名の構造

- 倉敷芸術学大学(`kusa.ac.jp`)を例にすると、`kusa`が固有のドメイン名を表し、`ac`が大学(academy)や高専、専門学校などの高等教育機関を、`jp`が日本を表している。
- ドメインを使用した場合には、それぞれのホスト名の後にその組織のドメイン名をつける。例えば、`www.kusa.ac.jp`, `piyo.kusa.ac.jp`, `kinoko.kusa.ac.jp`のようにつける
- DNSは木構造となっている（木をひっくり返したような構造）。`jp`ドメインの下には以下のような種類がある。

| jpより下の第２レベルドメイン | 意味                               |
| ---------------------------- | ---------------------------------- |
| ac                           | 大学                               |
| co                           | 企業                               |
| ed                           | 学校（幼稚園、小中学校、各種学校） |
| go                           | 政府機関                           |
| cr                           | 法人（財団法人、社団法人）         |
| ne                           | ネットワークサービスの提供組織     |
| gr                           | 法人資格を持たない任意団体、個人   |
| ad                           | JPNICの会員                        |
| lg                           | 地域公共団体                       |
| tokyo, osakaなど             | 地域ドメイン                       |
| netone, naistなど            | 汎用ドメイン                       |

**ネームサーバー**

- ドメイン名を管理しているホストやソフトウェアのこと。設置された階層のドメインに関する情報を管理している。その管理する階層のことをゾーンという
- ルートの部分に設置されているサーバーをルートネームサーバーという。jpやorgなどを管理しているネームサーバーのIPアドレスが登録されている。
- また、DNSのプロトコル的制約により、ルートネームサーバーは13個のIPアドレスで表現され、AからMまでの名称がついている。そして負荷分散や対故障性の向上のため、IPエニーキャストによりサーバーの台数を増やしている
- ネームサーバがダウンしてしまうと、そのドメインに対するDNSの問い合わせに対応できなくなる。このため、耐障害性を向上させるために2つ以上のネームサーバーを設置することになっている
- ルートネームサーバーのIPアドレスの最新情報：https://www.internic.net/zones/named.root

**リゾルバ(Resolver)**

- DNSに問い合わせを行うホストやソフトウェアのこと。

#### DNSによる問い合わせ

![DNSによる問い合わせ](https://raw.githubusercontent.com/shinzanmono/Markdown/3081dab374c534b267cbcf7c3233cb87d2313e97/images/DNS-query.drawio.svg)

#### DNSはインターネットに広がる分散データ

- DNSは、ホスト名とIPアドレスの管理以外にも様々な情報を管理している。

| タイプ | 番号 | 内容                                   |
| ------ | ---- | -------------------------------------- |
| A      | 1    | ホストのIPアドレス（IPv4)              |
| NS     | 2    | ネームサーバー                         |
| CNAME  | 5    | ホストの別名に対する正式名             |
| SOA    | 6    | ゾーン内の登録データの開始マーク       |
| WKS    | 11   | ウェルノウンサービス                   |
| PTR    | 12   | IPアドレスの逆引き用のポインタ         |
| HINFO  | 14   | メールボックスやメーリングリストの情報 |
| MX     | 15   | メールサーバー(Mail Exchange)          |
| TXT    | 16   | テキスト文字列                         |
| SIG    | 24   | セキュリティの署名                     |
| KEY    | 25   | セキュリティの鍵                       |
| GPOS   | 27   | 地理的な位置                           |
| AAAA   | 28   | ホストのIPv6アドレス                   |
| NXT    | 30   | 次のドメイン                           |
| SRV    | 33   | サーバーの選択                         |
| *      | 255  | すべてのレコードの要求                 |

### ARP(Address Resolution Protocol)

#### ARPの概要

- アドレス解決のためのプロトコル。宛先IPアドレスを手がかりにして、パケットを受け取るべき機器のMACアドレスを知りたいときに利用する。宛先のホストが同一リンク上にない場合は、次ホップのルーターのMACアドレスをARPで調べる。
- このARPは、IPv4でのみ利用されIPv6では利用されない。代わりにICMPv6の近隣探索メッセージが利用される

#### ARPの仕組み

![ARPの仕組み](https://raw.githubusercontent.com/shinzanmono/Markdown/76d08b001cca566536dba1a1bfd34886ef8d8e71/images/ARP.drawio.svg)

#### IPアドレスとMACアドレスは両方とも必要？

- 「データリンクの宛先MACアドレスを見ればホストB宛だと分かるのに、なぜIPアドレスが必要なのか？」という疑問は、別のリンクに接続されたホストへパケットを配送することを考えると解決できる。なぜなら、ルーターを経由することで、データリンクの宛先が変わるから

![MACアドレスとIPアドレスの役割の違い](https://raw.githubusercontent.com/shinzanmono/Markdown/91163dec3da2896a622c116776b3d98e2b83484a/images/MACaddress-IPaddress-different.drawio.svg)

#### RARP(Reverse Address Resolution Protocol)

- RRAPはARPの逆で、MACアドレスからIPアドレスを知りたい場合、プリンタサーバーなどの小型の組み込み機器をネットワーク接続したいときに使われる。
- パソコンなどの場合は、キーボードでIPアドレスを入力したり、DHCPを使って自動的にIPアドレスを設定したりできるが、組み込み機器の場合、IPアドレスを入力するインターフェースが存在しなかったり、DHCPを使って動的なIPアドレスが設定されては困る場合もある。そのためのプロトコル

#### 代理ARP(Proxy ARP)

- 通常ARPパケットはルーターで遮断されるが、代理ARPを使うとルーターは隣のセグメントに転送することができる。これにより、2つ以上に分かれたセグメントが、1つのセグメントであるかのように振る舞うことができる

#### ICMP(Internet Control Message Protocol)

#### IPを補助するICMP

- ICMPには、IPパケットが目的のホストまで届くかどうかを確認する機能や、何らかの原因でIPパケットが廃棄されたときにその原因を通知してくれる機能、不十分な設定をより良い設定に変更してくれる機能などがある。これらの機能により、ネットワークが正常かどうか、設定ミスや機器の異常がないかを知ることができ、トラブルシューティングが楽になる
- ICMPには大きく分類すると、エラー通知のためのエラーメッセージと診断などを行う問い合わせメッセージの2種類がある

| タイプ（10進数） | 内容                                     |
| ---------------- | ---------------------------------------- |
| 0                | エコー応答(Echo Reply)                   |
| 3                | 到達不能(Destination Unreachable)        |
| 4                | 始点抑制(Source Quench)                  |
| 5                | リダイレクト(Redirect)                   |
| 8                | エコー要求(Echo Request)                 |
| 9                | ルーター広告(Router Advertisement)       |
| 10               | ルーター請願(Router Solicitation)        |
| 11               | 時間超過(Time Exceeded)                  |
| 17               | アドレスマスク要求(Address Mask Request) |
| 18               | アドレスマスク応答(Address Mask Reply)   |

#### 主なICMPメッセージ

**ICMP到達不能メッセージ（タイプ3）**

- IPルーターがIPデータグラムを宛先に配送できない場合、送信ホストに対して送るメッセージのこと。
- よく発生するエラーコードは1の「Host Unreachable」で、そのIPアドレスへの経路制御情報を持っていなかった場合か、そのコンピュータがネットワークに接続されていなかったことを意味する。あとコード4の「Fragmentation Needed and Don't Fragment was Set」は経路MTU探索で使われる。

| コード番号 | ICMP到達不能メッセージ                                       |
| ---------- | ------------------------------------------------------------ |
| 0          | Network Unreachable                                          |
| 1          | Host Unreachable                                             |
| 2          | Protocol Unreachable                                         |
| 3          | Port Unreachable                                             |
| 4          | Fragmentation Needed and Don't Fragment was Set              |
| 5          | Source Route Failed                                          |
| 6          | Destination Network Unknown                                  |
| 7          | Destination Host Unknown                                     |
| 8          | Source Host Isolated                                         |
| 9          | Communication with Destination Network is Administratively Prohibited |
| 10         | Communication with Destination Host is Administratively Prohibited |
| 11         | Destination Network Unreachable for Type of Service          |
| 12         | Destination Host Unreachable for Type of Service             |

**ICMPリダイレクトメッセージ（タイプ５）**

- 送信元ホストが最適ではない経路を使用しているのをルーターが検出したときに、そのホストに対して送信するメッセージ。このメッセージの中に、最適経路の情報と元のデータグラムが入っている

![ICMPリダイレクトメッセージ](https://raw.githubusercontent.com/shinzanmono/Markdown/55704728372108f996f43dbb9ff00dcdc52d192d/images/ICMP-redirect.drawio.svg)

**ICMP時間超過メッセージ（タイプ１１）**

- IPパケットには、生存時間（TTL)というフィールドがあり、パケットがルーターを通るたびに1ずつ減少し、0になるとIPデータグラムが破棄される機能がある。このときにIPルーターが、送信元に対してパケットが破棄されたことを通知するのがこれにあたる。

**ICMPエコーメッセージ（タイプ０、８）**

- 通信したいホストやルーターなどに、IPパケットが到達するかどうかを確認したいときに利用する。相手にICMPエコー要求メッセージを送り、相手がICMPエコー応答メッセージが返って来れば到達可能となる

#### そのほかのICMPメッセージ

**ICMP始点抑制メッセージ（タイプ４）**

- 低速の回線に創出している側のルーターのキューの残りが0になり、創出不能になったときにメッセージをIPパケットの送信元に送る。回線のどこかが混雑している場合に送られる。また、このメッセージは不公平な通信を引き起こす恐れがあるため、ほとんど利用されていない

**ICMPルーター探索メッセージ（タイプ９、１０）**

- 自分が繋がっているネットワークのルーターを見つけるときに利用されるホストがICMPルーター請願メッセージを送信すると、ルーターがICMPルーター広告メッセージを返す

**ICMPアドレスマスクメッセージ（タイプ１７、１８）**

- サブネットマスクを調べたいホストやルーターがある場合に利用される。ホストやルーターに対してICMPアドレスマスク要求メッセージを送り、ホストやルーターがICMPアドレスマスク応答メッセージを返すことでサブネットマスクの値を知ることができる

#### ICMPv6

- IPv4のICMPは補助のみしか役割を持たず、なくても通信ができる。しかしIPv6ではICMPの役割が大きくなり、ないと通信できなくなる。
- IPv6では、IPアドレスからMACアドレスを知るプロトコルがARPからICMP近隣探索メッセージに変更される。これは、IPv4のARP、ICMPリダイレクト、ICMPルーター選択メッセージなどの機能を組み合わせたもので、さらにIPアドレスの自動設定などの機能も提供する
- 0から127までがエラーメッセージで、128から255までが情報メッセージとなっている。また、133から137までを近隣探索メッセージとなる

**ICMPv6エラーメッセージ**

| タイプ（１０進数） | 内容           | 内容（英語）            |
| ------------------ | -------------- | ----------------------- |
| 1                  | 終点到達不能   | Destination Unreachable |
| 2                  | パケット過大   | Packet Too Big          |
| 3                  | 時間超過       | Time Exceeded           |
| 4                  | パラメータ問題 | Parameter Problem       |

**ICMPv6情報メッセージ

| タイプ（１０進数） | 内容                             | 内容（英語）                             |
| ------------------ | -------------------------------- | ---------------------------------------- |
| 128                | エコー要求メッセージ             | Echo Request                             |
| 129                | エコー応答メッセージ             | Echo Reply                               |
| 130                | マルチキャストリスナー問い合わせ | Multicast Listener Query                 |
| 131                | マルチキャストリスナー報告       | Multicast Listener Report                |
| 132                | マルチキャストリスナー終了       | Multicast Listener Done                  |
| 133                | ルーター請願メッセージ           | Router Solicitation                      |
| 134                | ルーター告知メッセージ           | Router Advertisement                     |
| 135                | 近隣要請メッセージ               | Neighbor Solicitation                    |
| 136                | 近隣告知メッセージ               | Neighbor Advertisement                   |
| 137                | リダイレクトメッセージ           | Redirect Message                         |
| 138                | ルーターリナンバリング           | Router Renumbering                       |
| 139                | 情報問い合わせ                   | ICMP Node Information Query              |
| 140                | 情報応答                         | ICMP Node Information Response           |
| 141                | 逆近隣探索要請メッセージ         | Inverse Neighbor Discovery Solicitation  |
| 142                | 逆近隣探索告知メッセージ         | Inverse Neighbor Discovery Advertisement |

**近隣探索**

- タイプ133から137までが近隣探索メッセージ。IPv6アドレスとMACアドレスの対応関係を調べるとき、近隣要請メッセージでMACアドレスを問い合わせ、近隣告知メッセージでMACアドレスを通知する。近隣要請メッセージは、IPv6のマルチキャストアドレスを使用して送信される
- IPv6ではプラグ＆プレイ機能を実現するため、DHCPサーバーがない環境下でも、IPアドレスを自動設定することができる。ルーターがないネットワークなら、MACアドレスでリンクローカルユニキャストアドレスを作成する。ある環境なら、ルーターからIPv6アドレスの上位ビットの情報を取得し、下位ビットにはMACアドレスを設定する。これは、ルーター要請メッセージとルーター告知メッセージを使用して行う

### DHCP(Dynamic Host Configuration Protocol)

#### プラグ＆プレイを可能にするDHCP

- 面倒なIPアドレスの設定を自動化したり、配布するIPアドレスの一括管理を行うプロトコル。コンピュータをネットワークに接続しただけでTCP/IPによる通信ができるようになる。IPv4, IPv6共に利用可能

![DHCP](https://raw.githubusercontent.com/shinzanmono/Markdown/614f1f9566e56cba35a4567eddd5b42e902d4db8/images/DHCP-works.drawio.svg)

#### DHCPの仕組み

- DHCPを利用するには、DHCPサーバーの立ち上げとDHCPで配布するIPアドレスをDHCPサーバーに設定する必要がある。他にも、サブネットマスク、経路制御の情報、DNSサーバーのアドレスなども、必要に応じて設定する
- DHCPが利用するパケットは、DHCP発見パケット、DHCP提供パケット、DHCP要求パケット、DHCP確認応答パケットの4種類ある。
- DHCPでIPアドレスを取得する流れ
  1. DHCPクライアント（略クライアント）は、DHCP発見パケットを送信し、DHCPサーバー（略サーバー）にIPアドレスやネットマスクなどのネットワークの設定を要求
  2. サーバーは、DHCP提供パケットをクライアントに送信し、使用可能なネットワークの設定を提供
  3. クライアントは、DHCP要求パケットをサーバー送信し、DHCP提供パケットで通知された設定を使用すると要求
  4. サーバーは、DHCP確認応答パケットをクライアントに送信し、DHCP要求パケットに対する結果を返す
- また、DHCPサーバーに障害が発生すると、セグメントないのホストが通信不能になってしまうのを防ぐため、複数のDHCPサーバーを起動することが推奨されている。しかし、複数を利用すると、それぞれのDHCPサーバー内部に記録されているIPアドレスの配布情報が同じにならず、重複する危険性がある
- それを防ぐために、DHCPサーバーでは、配布前にICMPエコー要求パケットを送信し、返事がこないことを確認する。また、DHCPクライアントでは、DHCPサーバーから配布されたIPアドレスに対してARP要求パケットを送信し、応答がないことを確認する

#### DHCPリレーエージェント

- 一般家庭で構築されるネットワークの場合、イーサネット（無線LAN）のセグメントは1つであることが多く、接続するホストの台数も多くないため、DHCPサーバーは1台で十分。そのDHCPサーバーはブロードバンドルーターが担うのが普通
- 企業や学校などの大きな組織で構築されるネットワークの場合、複数のイーサネット（無線LAN）で構築されるのが普通。このような環境で1つのセグメントごとにDHCPサーバーを設置、設定するのは大変（例えば100台のルータがある場合、100台全てにIPアドレスの範囲の設定、配布する範囲の変更をすること）。
- そこで、DHCPリレーエージェントを使ったDHCPの設定を一元管理する方法がある。これにより、複数の異なるセグメントのIPアドレスの割り当てを1つのDHCPサーバーで管理・運用することができる
- やり方は、DHCPサーバーの代わりにDHCPリレーエージェント（ルーターであることが多い）を設置し、DHCPサーバーのIPアドレスを割り当てる。そして、DHCPサーバーには、それぞれのセグメントごとに配布するIPアドレスの範囲を登録する。
- DHCPリレーエージェントの仕組み
  1. DHCPクライアントは、DHCP要求パケットなどのブロードキャストパケットを送信する
  2. DHCPリレーエージェントは、クライアントが送信したパケットを受信し、それをDHCPサーバーに転送する。
  3. DHCPサーバーは、転送されたパケットを処理し、DHCPリレーエージェントに応答を返す。
  4. DHCPリレーエージェントは、サーバーから送られた応答をクライアントに転送する。

![DHCPリレーエージェント](https://raw.githubusercontent.com/shinzanmono/Markdown/d5c5980914ddeb333e81679c7974e8511d2c7e2b/images/DHCP-relay-agent.drawio.svg)

### NAT(Network Address Translator)

- ローカルネットワークでプライベートIPアドレスを使用し、インターネットへ接続するときにグローバルIPアドレスへ変換する。さらに、アドレスだけでなくNAPT(Network Address Ports Translator)の登場で、1つのグローバルIPアドレスで複数のホスト間の通信ができるようになる

#### NATの仕組み

![NATとNAPTの仕組み](https://raw.githubusercontent.com/shinzanmono/Markdown/26162f307ddd329d400cca2b35a1a1dffb4e070f/images/NAT-NAPT-works.drawio.svg)

#### NAT-PT(NAPT-PT)

- IPv6ヘッダとIPv4ヘッダを付け替える技術で、IPv6しか設定されていないホストでも、IPv4の環境と通信できるようになる
- DNSと連携してIPヘッダを付け替えるDNS -ALG方式が今後、期待されている

#### NATの問題点

- NATの外側から内側のサーバーに接続することができない
- 変換テーブルの作成や変換処理のオーバーヘッドが生じる
- 通信中にNATが異常動作して再起動したときには、すべてのTCPコネクションがリセットされる
- NATを2台用意して故障時に切り替えるようにしても、TCPコネクションはリセットされる

#### NATの問題点の解決とNAT超え

- 上記の問題点を解決する方法は主に2つある。1つはIPv6を使うこと。もう1つはNATがある環境を前提にアプリケーションを作成すること。
- NATがあってもNATの外側と内側が通信できるようにすることをNAT超えという。
- しかし、NATフレンドリーなアプリケーションには問題点もある。仕組みが複雑になるため、アプリケーションの作成や、想定されていない環境では動作しなくなったり、トラブルシューティングが難しくなる点などがある。
