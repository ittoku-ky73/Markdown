## Chapter6 TCPとUDP

### トランスポート層の役割

- TCPは信頼性のある通信を提供し、UDPは同報通信や、細かい制御をアプリケーションに任せたほうが良い通信を提供する

#### トランスポート層とは

- 郵便物で例えると、郵便配達員（IP）は宛先の住所（宛先IPアドレス）を参照して、目的の家（コンピュータ）に郵便物（IPデータグラム）を配達する。目的の家まで届いたら、家の人（トランスポートプロトコル）が宛名を見て、誰宛（プログラム）かを判断する
- もしも、宛名が書かれていない郵便物が届いてしまうと、誰に渡せばよいかわからなくなる（学校や会社に届いた場合だともっとわからない）
- TCP/IPの通信では、プログラム（宛名）を指定する必要があります。この役割を実現するためにポート番号という識別子を使う。これにより、トランスポート層の上位層のアプリケーション層の処理を行うプログラムを識別する。

#### 通信の処理

- 前述では、プログラムがアプリケーションプロトコルの処理、宛名（氏名）がアプリケーションプロトコルになる。
- TCP/IPのアプリケーションプロトコルの多くは、一般にクライアント/サーバーモデルと呼ばれる形式で作られている。サーバーはあらかじめプログラムが起動されていて、クライアントからのプログラムの要求を待ち、要求されれば、サーバーがそれを処理する形
- これらのサーバープログラムはUNIXではデーモン（ホストサーバー上で常に常時起動されていて特定の処理を行うプロセス）という。httpd(HTTPデーモン)、sshd(sshデーモン)というように呼ばれる。また、UNIXでは、個々のデーモンを別々に動かすのではなく、その代表としてクライアントからの要求を待つinetd(インターネットデーモン)というスーパーデーモンが使われる。スーパーデーモンは、サービスの要求を受けると分身(fork)して、sshdなどのデーモンに変身(exec)する
- 要求がどのサーバー（デーモン）に向けられたかは、受信したパケットの宛先ポート番号に記されている。22番ならsshd、80番ならhttpdのようにコネクションを確立させる。

#### 2つのトランスポートプロトコルTCPとUDP

**TCP(Transmission Control Protocol)**

- TCPはコネクション指向で、信頼性のあるストリーム型（切れ目のないデータ構造）のプロトコル。送信者のアプリケーションがTCPを使ってメッセージを送信すると、送信した順番は保たれるが、区切り目のないデータ構造として、アプリケーションに届く
- これは、送信側のアプリケーションが100バイトを10個のデータとして送ったら、受信側のアプリケーションでは区切り目のない1000バイトのデータとして受信する可能性がある。そのため、TCPを利用するアプリケーションの中には、メッセージの長さや区切り目を表す情報を、送信するメッセージの中に埋め込むものもある
- またTCPでは、信頼性を提供するために「順序制御」や「再送制御」を行う。そして「フロー制御（流量制御）」や「輻輳制御」、ネットワークの利用率を向上させる仕組みなど、数多くの機能を持つ

**UDP(User Datagram Protocol)**

- UDPは、信頼性のないデータグラムのプロトコル。細かい処理は上位層のアプリケーションが担う。UDPは、送信した時のメッセージの大きさは保たれるが、パケットが到達する保証がないため、必要に応じてアプリケーションがメッセージの再送処理をしなければならない
- それは、送信側のアプリケーションが送信者は100バイトごとにメッセージを送信したら、受信側のアプリケーションでは100バイトごとにメッセージを受信する。UDPではアプリケーションが長さを指定したメッセージの「長さ」を受信側のアプリケーションに伝えられるため、送られてくるメッセージの中に、長さや区切り目の情報を入れる必要はない。ただし、UDPは信頼性がないためメッセージが途中で失われた場合には届かない

#### TCPとUDPの使い分け

- TCPは、トランスポート層で信頼性のある通信を実現する必要のある場合に利用され、UDPは高速性やリアルタイム性を重視する通信や同報通信（やIP電話）などに利用される。
- また、マルチキャストやブロードキャストの通信ではUDPが使われ、RIPやDHCPなど、ブロードキャストを使うプロトコルでもUDPが利用される

**ソケット**

- アプリケーションからTCPやUDPを利用するときには、OSが用意しているライブラリを利用することになる。このライブラリを一般にAPI(Application Programming Interface)という
- TCPやUDPを利用して通信するときは、ソケットと呼ばれるAPIが広く使われている。ソケットはBSD UNIXで開発され、その後、WindowsのWinsockや、組み込み機器用のOSなどに移植された。
- アプリケーションはソケットを利用して、通信相手のIPアドレスやポート番号を設定したり、データの送信や受信の要求をする



