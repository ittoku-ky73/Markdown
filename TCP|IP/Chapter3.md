## Chapter3 データリンク

- この章では、MACアドレス、媒体共有・非共有のネットワーク、スイッチング技術、ループ検出、VLANや、具体的な通信手段であるイーサネット、無線LAN、PPPなどを紹介する

### データリンクの役割

- 「データリンク」という言葉は、OSI参照モデルのデータリンク層を指す用語と、具体的な通信手段（イーサネット、無線LANなど）を指す一般的な用語、がある
- データリンク層のプロトコルで使用される通信媒体は決められている。ツイストケーブル（より対線）、同軸ケーブル、光ファイバー、電波、赤外線などがある。あと、スイッチやブリッジ、リピーターなどが中継する場合もある
- コンピュータの情報は全て2進数の0と1で表されますが、実際の通信媒体でやり取りされるのは電圧の変化や光の点滅、電波の強弱など。
- これらを0と1に変換する働きを担うのが物理層。0と1の列を「フレーム」として意味のある塊にまとめるのがデータリンク層

**データリンクのセグメント**

- データリンク層のセグメントは「区切られた1つのネットワーク」を指すのに使われる

**ネットワークのトポロジー**

- ネットワークの接続形態、構成形態のことをトポロジー（Topology）という。
- トポロジーにはバス型、リング型、スター型、メッシュ型などがある

### データリンクの技術

- MACアドレスは、データリンクに接続しているノードを識別するために利用される。
- MACアドレスは48ビットの長さを持ち、下記のような構造を持つ

![MAC Address](https://raw.githubusercontent.com/shinzanmono/Markdown/8922a4f09155bcb80d8a3c54780cce1af305cea9/images/mac-address.drawio.svg)

- 3~24ビットはベンダ識別子と言い、NICの製造メーカーごとに特定の数字が割り当てられている。25~48ビットは、メーカーが製造したカード（NIC）ごとに違う数字を割り当てる。こうすることによりユニークになる

**MACアドレスは世界で唯一とは限らない**

- 同じMACアドレスが存在しても、それが同じデータリンク内になければ問題にはならない

- ネットワークインターフェースを備えたマイコンボードなどでは、利用者が自由にMACアドレスを設定することができる。また仮想マシンでは物理インターフェースがないため、ソフトウェアによってMACアドレスを生成し割り当てる

**ベンダ識別子**

- ネットワークアナライザの中には、LAN上のパケットがどのメーカーのインターフェースから送信された物なのかを表示できる製品がある
- ベンダ識別子はOUI（Organizationally Unique Identifier）に一般公開されている。
  - [OUI 確認](http://standards-oui.ieee.org/oui/oui.txt)

#### 媒体共有型のネットワーク

- 通信媒体（通信、メディア）の使い方という観点から見ると、ネットワークは媒体共有型と媒体非共有型に分けることができる
- 媒体共有型のネットワークは、通信媒体を複数のノードで共有するネットワーク。初期のイーサネットやFDDIなど
- 媒体共有型のネットワークで優先権を制御する仕組みとしては、コンテンション方式やトークンパッシング方式がある

**コンテンション方式**

- コンテンション方式（Contention）とは、データの送信権を競争で奪い取る方式。CSMA方式とも呼ばれる
- 早い者勝ちで通信炉を使用してデータを送信する。複数のステーション（データリンクではノードのこと）からデータが同時に送信された場合、お互いのデータが衝突し壊れる（コリジョン）。ネットワークが混雑すると性能が低下する

![Contention方式](https://raw.githubusercontent.com/shinzanmono/Markdown/a7e2273d6c7654f7a2c6c658b5b8b7084d2ca50e/images/contention.drawio.svg)

- イーサネットの一部では、CSMA方式を改良したCSMA/CD(Collision Detection)方式が採用されている
  - 搬送波が流れていなければ全てのステーションはデータを送信しても良い
  - 衝突が発生した場合、送信を取りやめる（ジャム信号という32ビットの特別な信号を送る）。送信をすぐに取りやめることにより通信路を解放することがポイント
  - 送信を取りやめた場合は、乱数時間を待ってから送信をやり直す

#### トークンパッシング方式

- トークンと呼ばれるパケットを巡回させ、このトークンで送信権を制御し、トークンを持っているステーションだけデータを送信できる
- 利点は、衝突が発生しない、誰にでも平等に送信権が回ってくる
- 欠点は、トークンが回ってくるまでデータを送信できない。しかし、アーリートークン方式やアベンドトークン方式（自分が送信したデータが一周するまで待たずに、トークンを次に渡す）、複数のトークンを同時に巡回させるなどの技法により、工夫されている

![Token passing方式](https://raw.githubusercontent.com/shinzanmono/Markdown/6053847abf29cb0d61349c9aea1895fa49fb2839/images/token-passing.drawio.svg)

#### 媒体非共有型のネットワーク

- ステーションがスイッチに直接接続され、そのスイッチがフレームを転送する方式。この方式はATMなどで採用されている他、最近のイーサネットでも主流になっている
- スイッチに高度な機能を持たせることによって、仮想的なネットワーク（VLAN：バーチャルLAN）の構築やデータの流量の制御なども可能になる。
- その反面、スイッチが故障すると全てのコンピュータ間の通信ができなくなる

![媒体非共有型](https://raw.githubusercontent.com/shinzanmono/Markdown/167f76101830e1b20c50e55b7e5f47c5c026446f/images/%E5%AA%92%E4%BD%93%E9%9D%9E%E5%85%B1%E6%9C%89%E5%9E%8B.drawio.svg)

**半二重通信と全二重通信**

- 半二重通信とは、送信をしている間は受信できず、受信している間は送信できないような通信のこと。無線のトランシーバーと同じ
- 全二重通信とは、スイッチやツイストペアケーブル（または光ファイバーケーブル）を使って、スイッチのポートとコンピュータを1体1で接続して送受信を同時に行うことができる通信のこと

#### MACアドレスによる転送

- 同軸ケーブル上で利用されるイーサネット（10BASE5, 10BASE2）などの通信媒体を共有する方式では、同時に1つのホストしかデータを送信できないが、ハブやコンセントレータと呼ばれる機器によってスター型に接続されるようになるとイーサネットなどでも利用できるようになる
- イーサネットスイッチは、複数のポート（外部インターフェース）を持ったブリッジと言える。送出する時に参照するテーブルを転送表という
- 転送表は、自動で生成される。また、パケットを受け取った時にその送信もとMACアドレスとインターフェースの対を転送表に書き込んでおき、次回の通信の際に余計な通信が減る。これを自己学習という
- MACアドレスは改装性がないので、たくさんの端末をつなげる場合は複数のデータリンクに分け、ネットワーク層でIPアドレスのような改装的なアドレスを使って束ねる必要がある

**スイッチの転送方式**

- スイッチの転送方式には、ストア＆フォワードと、カットスルーの2つがある

- ストア＆フォワード方式は、イーサネットフレーム末尾のFCSをチェックしてから転送を行う

- カットスルー方式はフレームを全部蓄積し終わる前に処理が始まり、送信先のMACアドレスが分かり次第データの転送を開始する

#### ループを検出するための技術

- ブリッジでネットワークを接続する時に、ループを作ってしまうと最悪ネットワークを、メルトダウン（異常なパケットがネットワークを埋め尽くし送信不能に陥ること）させてしまう
- そこでループを解決する方法として、スパニングツリー方式と、ソースルーティングと呼ばれる方式の2つがある

**スパニングツリー**

- スパニングツリー方式は、IEEE802.1Dで定義されている。各ブリッジは1~10間隔で、BPDU（Bridge Protocol Data Unit）と呼ばれるパケットを交換して、通信に使用するポートと使用しないポートを決定し、ループを消すように制御する
- IEEE802.1Dで定義されているスパニングツリーは障害児の切り替わりなどに数十秒程度の時間がかかる問題がある。その解決に、IEEE802.1WでRSTP（Rapid Spanning Tree Protocol）が定義され、切替が数秒以下になった

**ソースルーティング**

- ソースルーティングは、IBMによってToken Ringネットワークように開発された。
- この方式は、送信コンピュータがどのブリッジを経由してフレームを流すかを決定し、フレームのRIF（Routing Information Field）に書き込み、ブリッジはRIF情報をもとに配送処理を行う。
- この仕組みの場合には送信コンピュータ自体がソースルーティング機能を持っていなければいけない

#### VLAN（Virtual LAN）

- 通常、ネットワークの管理をしていると、ネットワークの負荷を分散させたり、部署や席の入れ替えをしたりするたびに、ネットワークのトポロジーを変更しなければならない場合がある。その場合、配線を変更する必要がある
- VLAN技術を利用できるブリッジ（スイッチ）を使えば、配線を変えずに、ネットワークの構造を変えることができる
- VLANは、ブリッジ・レイヤ２スイッチの機能に加え、異なるVLAN間の通信を遮断する。これにより、余分なパケットが流れず、効率的な運用が可能になる
- またスイッチのポートごとにセグメントを分けることで、ブロードキャストのトラフィックが流れる範囲（ブロードキャストドメイン）を区切ることができ、ネットワークの負荷を軽減したりセキリュティを向上させることができる。
- 異なるセグメント間で通信するためには、ルーターの機能を備えたスイッチ（レイヤ３スイッチ）を利用するか、セグメント間をルーターで結ばなければいけない
- このVLANを拡張し、異なるスイッチを跨いだセグメントを構築できるようにしたものがIEEE802.1Qで標準化されたタグVLANがある
- タグVLANは、セグメントごとに一意となるVLANIDを設定して、スイッチ間でフレームを転送する時にはイーサネットのヘッダの中にVLANタグを挿入し、その値をもとにしてどのセグメントにフレームを転送するかを決定する
- VLANを導入することによって、配線の変更を行うことなく、ネットワークセグメントを変更できるが、管理が難しい

![VLAN](https://raw.githubusercontent.com/shinzanmono/Markdown/68ee56a05f9430a4d0efaebdf923679379c2f499/images/VLAN.drawio.svg)